::: {#__next reactroot=""}
![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNMjIuOCA1LjVjLS45IDAtMS42LjctMS42IDEuNnMuNyAxLjYgMS42IDEuNiAxLjYtLjcgMS42LTEuNi0uNy0xLjYtMS42LTEuNnptLTE5LjEuNmMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMXMtLjUtMS4xLTEtMS4xSDMuN3ptMTkuMSA1LjhjLS45IDAtMS42LjctMS42IDEuNnMuNyAxLjYgMS42IDEuNiAxLjYtLjcgMS42LTEuNi0uNy0xLjYtMS42LTEuNnptLTE5LjEuNWMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMXMtLjUtMS4xLTEtMS4xSDMuN3ptMTkuMSA1LjljLS45IDAtMS42LjctMS42IDEuNiAwIC45LjcgMS42IDEuNiAxLjZzMS42LS43IDEuNi0xLjZjMC0uOS0uNy0xLjYtMS42LTEuNnptLTE5LjEuNWMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMSAwLS42LS41LTEuMS0xLTEuMUgzLjd6Ij48L3BhdGg+PC9zdmc+)

[よくわかるcontextの使い方](/hsaki/books/golang-context){.View_mobileBookTitle__NGx1l}

::: View_fontToggleContainer__X2wNX
[]{.View_fontToggleContent__mTbxr}

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNOC40IDMuMkwzLjMgMTYuOGgyLjFMNyAxMi42aDUuMmwuOS0yLjQtMi42LTYuOUg4LjR6bTEgMi44bDEuNyA0LjVINy44TDkuNCA2em03LjMuM2wtNS4xIDEzLjZoMi4xbDEuNi00LjJoNWwxLjYgNC4ySDI0TDE4LjggNi4zaC0yLjF6bTEuMSAyLjhsMS43IDQuNWgtMy40bDEuNy00LjV6TTExLjUgMjJ2Mi4xSDI0VjIySDExLjV6Ij48L3BhdGg+PC9zdmc+)
:::

::: View_sidebarWrapper__J4kZS
[![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMzc3LjQgODguMyIgaGVpZ2h0PSIyMSI+PGcgZmlsbD0iIzExMSI+PHBhdGggZD0iTTIzMyA1Ni44aC0zOWMuNSAzLjUgMi4yIDYuOCA0LjggOS4yIDIuNyAyLjMgNi4yIDMuNSA5LjggMy40IDIuOCAwIDUuNi0uNSA4LjItMS43IDIuNS0xLjEgNC44LTIuOCA2LjUtNWw4LjIgOS41Yy0yLjUgMy40LTUuNyA2LjEtOS41IDcuOS00LjYgMi4yLTkuNiAzLjMtMTQuNyAzLjItNS43LjEtMTEuNC0xLjItMTYuNS00LTQuNS0yLjUtOC4yLTYuMy0xMC43LTEwLjlzLTMuOC05LjgtMy43LTE1LjF2LTIuMmMtLjEtNS43IDEuMS0xMS4zIDMuNS0xNi41IDIuMi00LjcgNS43LTguNiAxMC4xLTExLjMgNC43LTIuOCAxMC4xLTQuMiAxNS41LTQuMSA1LjItLjEgMTAuMyAxLjEgMTQuOSAzLjcgNC4xIDIuNSA3LjQgNi4yIDkuNCAxMC41IDIuMiA1LjEgMy4zIDEwLjUgMy4yIDE2LjF2Ny4zem0tMTYuOS0xMi45Yy4xLTIuOS0uOS01LjctMi44LTcuOS0xLjgtMS45LTQuNC0yLjktNy45LTIuOS0yLjktLjEtNS44IDEuMS03LjcgMy4yLTIgMi42LTMuMyA1LjctMy42IDloMjJ2LTEuNHpNMTI4LjMgNjcuOWgzNi4xdjE0LjdoLTU2LjlWNzJsMzUuOC01NC4zaC0zNi4yVjIuOWg1Ni42djEwLjRsLTM1LjQgNTQuNnpNMjQ4LjggNTAuN2MwLTE5LjEgMTIuNy0yOS4yIDI4LjItMjkuMnMyNy45IDEwLjEgMjcuOSAyOS4yVjgyaC0xNlY1MS40YzAtMTAuNi00LjgtMTYuMS0xMi0xNi4xcy0xMi40IDUuNS0xMi40IDE2LjF2MzAuN2gtMTUuOGwuMS0zMS40ek0zMjAuMyA1MC43YzAtMTkuMSAxMi43LTI5LjIgMjguMi0yOS4yczI3LjkgMTAuMSAyNy45IDI5LjJWODJoLTE2VjUxLjRjMC0xMC42LTQuOC0xNi4xLTEyLTE2LjFTMzM2IDQwLjggMzM2IDUxLjR2MzAuN2gtMTUuOGwuMS0zMS40eiI+PC9wYXRoPjwvZz48cGF0aCBmaWxsPSIjM0VBOEZGIiBjbGFzcz0ibG9nb19zdmdfX3N0MCIgZD0iTTIuNCA4My4zaDE3Yy45IDAgMS43LS41IDIuMi0xLjJMNjguNCA1LjJjLjYtMS0uMS0yLjItMS4zLTIuMkg1MWMtLjggMC0xLjUuNC0xLjkgMS4xTDEuNiA4MS45Yy0uMy42LjEgMS40LjggMS40ek02MSA4Mi4xbDIyLjEtMzUuNWMuNy0xLjEtLjEtMi41LTEuNC0yLjVoLTE2Yy0uNiAwLTEuMi4zLTEuNS44TDQxLjUgODEuMmMtLjYuOS4xIDIuMSAxLjIgMi4xSDU5Yy44IDAgMS42LS40IDItMS4yeiI+PC9wYXRoPjwvc3ZnPg==)](/){.View_sidebarLogo__U_3VI}

::: View_sidebarScrollArea__VkX5E
::: View_sidebarBook__n15Cv
[](/hsaki/books/golang-context){.View_sidebarBookCover__tuM0r}

::: {.BookCoverImage_container__e04p5 .BookCoverImage_border__dyU2h style="width:70px"}
![よくわかるcontextの使い方](https://res.cloudinary.com/zenn/image/fetch/s--xe7dAlE9--/c_fill%2Cf_jpg%2Cfl_progressive%2Ch_350%2Cq_80%2Cw_250/https://storage.googleapis.com/zenn-user-upload/book_cover/4edbbf97c2.jpg){width="70"
height="98"}
:::

::: View_sidebarBookInfo__N_tXH
[よくわかるcontextの使い方](/hsaki/books/golang-context){.View_sidebarBookTitle__IRpEP}[]{style="display:block;width:1px;height:0.3rem;flex-shrink:0"}

::: {.LikeButton_container__lhHqp .style-large}
![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMTEwIDExMCIgY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZV9fX2Rtd00iPjxwYXRoIGNsYXNzPSJMaWtlQnV0dG9uX3N2Z0xpa2VMaW5lX19uY1lnNyIgZD0iTTczLDI0YTIzLjc4LDIzLjc4LDAsMCwwLTE1Ljg5LDYuMTksMy4xNCwzLjE0LDAsMCwxLTQuMTgsMEEyMy44MSwyMy44MSwwLDAsMCwzNywyNGEyMiwyMiwwLDAsMC0yMiwyMmMwLDE2LjY3LDE5LjY0LDMyLjgyLDI1LjExLDM3LjkzLDIuODQsMi42NSw2LjE1LDUuNjQsOC45Miw4LjEzYTguOSw4LjksMCwwLDAsMTEuOSwwYzIuNzctMi40OSw2LjA3LTUuNDgsOC45MS04LjEzQzc1LjM3LDc4LjgxLDk1LDYyLjY2LDk1LDQ2QTIyLDIyLDAsMCwwLDczLDI0WiIgZmlsbD0iY3VycmVudENvbG9yIj48L3BhdGg+PHBhdGggY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZUlubmVyX19BT0dfdCIgZmlsbD0iY3VycmVudENvbG9yIiBkPSJNNjYuMjUsNzYuNDJjLS43MS42NC0xLjMyLDEuMi0xLjgyLDEuNjctMi41MSwyLjMzLTUuMzksNS03Ljk0LDcuMjVhMi4yMSwyLjIxLDAsMCwxLTMsMEM1MSw4Myw0OC4xLDgwLjQyLDQ1LjU5LDc4LjA5Yy0uNS0uNDctMS4xMi0xLTEuODItMS42N0MzOC4wOSw3MS4yOSwyMyw1Ny42NywyMyw0NkExNCwxNCwwLDAsMSwzNywzMmExNS45MiwxNS45MiwwLDAsMSwxMS42NSw1LjIzbDQuNzMsNWEyLjIsMi4yLDAsMCwwLDMuMjMsMGw0LjcyLTVBMTYuMDYsMTYuMDYsMCwwLDEsNzMsMzIsMTQsMTQsMCwwLDEsODcsNDZDODcsNTcuNjcsNzEuOTMsNzEuMjksNjYuMjUsNzYuNDJaIj48L3BhdGg+PGcgY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZURlY29yYXRpb25fX1gydjUzIj48Y2lyY2xlIGN4PSI0MS41IiBjeT0iOS41IiByPSIzLjUiIGZpbGw9IiMzZWE4ZmYiPjwvY2lyY2xlPjxjaXJjbGUgY3g9Ijk4LjUiIGN5PSIyNi41IiByPSIzLjUiIGZpbGw9IiNmZmRjNmUiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEzIiBjeT0iMTkiIHI9IjUiIGZpbGw9IiNjMDY3ZjQiPjwvY2lyY2xlPjxjaXJjbGUgY3g9Ijc3IiBjeT0iOSIgcj0iNSIgZmlsbD0iI2Y3NjY4NSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjYuNSIgY3k9IjkyLjUiIHI9IjMuNSIgZmlsbD0iI2Y3NjY4NSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTA1LjUiIGN5PSI0OC41IiByPSIzLjUiIGZpbGw9IiNjMDY3ZjQiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjQuNSIgY3k9IjYwLjUiIHI9IjMuNSIgZmlsbD0iIzNlYThmZiI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iOTQuNSIgY3k9IjczLjUiIHI9IjEuNSIgZmlsbD0iIzNlYThmZiI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTYuNSIgY3k9Ijc1LjUiIHI9IjEuNSIgZmlsbD0iI2ZmZGM2ZSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iNzguNSIgY3k9IjkxLjUiIHI9IjEuNSIgZmlsbD0iI2ZmZGM2ZSI+PC9jaXJjbGU+PC9nPjwvc3ZnPg==){.LikeButton_svgLike___dmwM}
:::
:::
:::

::: View_sidebarChapters__oJuLT
[[01]{.View_sidebarChapterNum__oSZ_8}はじめに](/hsaki/books/golang-context/viewer/intro){#chapter-1
.View_sidebarChapterLink__hQp61}[[02]{.View_sidebarChapterNum__oSZ_8}contextの概要](/hsaki/books/golang-context/viewer/definition){#chapter-2
.View_sidebarChapterLink__hQp61}[[03]{.View_sidebarChapterNum__oSZ_8}Doneメソッド](/hsaki/books/golang-context/viewer/done){#chapter-3
.View_sidebarChapterLink__hQp61}[[04]{.View_sidebarChapterNum__oSZ_8}キャンセルの伝播](/hsaki/books/golang-context/viewer/cancelchain){#chapter-4
.View_sidebarChapterLink__hQp61}[[05]{.View_sidebarChapterNum__oSZ_8}Deadlineメソッドとタイムアウト](/hsaki/books/golang-context/viewer/deadline){#chapter-5
.View_sidebarChapterLinkActive__XxopU
.View_sidebarChapterLink__hQp61}[[06]{.View_sidebarChapterNum__oSZ_8}Errメソッド](/hsaki/books/golang-context/viewer/err){#chapter-6
.View_sidebarChapterLink__hQp61}[[07]{.View_sidebarChapterNum__oSZ_8}Valueメソッド](/hsaki/books/golang-context/viewer/value){#chapter-7
.View_sidebarChapterLink__hQp61}[[08]{.View_sidebarChapterNum__oSZ_8}Valueメソッドを有効に使うtips](/hsaki/books/golang-context/viewer/appliedvalue){#chapter-8
.View_sidebarChapterLink__hQp61}[[09]{.View_sidebarChapterNum__oSZ_8}contextの具体的な使用例](/hsaki/books/golang-context/viewer/usage){#chapter-9
.View_sidebarChapterLink__hQp61}[[10]{.View_sidebarChapterNum__oSZ_8}パッケージへのcontext導入について](/hsaki/books/golang-context/viewer/pkgdesign){#chapter-10
.View_sidebarChapterLink__hQp61}[[11]{.View_sidebarChapterNum__oSZ_8}contextの内部実体](/hsaki/books/golang-context/viewer/internal){#chapter-11
.View_sidebarChapterLink__hQp61}[[12]{.View_sidebarChapterNum__oSZ_8}おわりに](/hsaki/books/golang-context/viewer/appendix){#chapter-12
.View_sidebarChapterLink__hQp61}
:::
:::
:::

::: {.section .View_section__8hd21 style="font-size:16px"}
::: View_sectionHeader__JGnT7
::: ViewerWrapper_container__Cg8HA
::: View_chapterContent__FQOka
[Chapter 05]{.View_chapterTitleNumber__23_eN}
:::

[]{style="display:block;width:1px;height:0.7rem;flex-shrink:0"}

# Deadlineメソッドとタイムアウト {#deadlineメソッドとタイムアウト .View_chapterTitle__tslMs}

[]{style="display:block;width:1px;height:0.8rem;flex-shrink:0"}[](/hsaki){.UserLinkSmall_container__PkgaY}

::: {style="width:35px;height:35px"}
![さき(H.Saki)](https://res.cloudinary.com/zenn/image/fetch/s--FESoQ9n2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_70/https://storage.googleapis.com/zenn-user-upload/avatar/51291e09a0.jpeg){.AvatarImage_border__33_UE
.AvatarImage_plain__BCJNs width="35" height="35" loading="lazy"
referrerpolicy="no-referrer"}
:::

::: {.UserLinkSmall_text__2BG_S style="width:calc(100% - 35px);font-size:0.87rem"}
::: UserLinkSmall_name__eqTEi
さき(H.Saki)
:::

::: UserLinkSmall_additionalText__2MgRM
2021.08.29に更新
:::
:::
:::
:::

::: ViewerWrapper_container__Cg8HA
[]{style="display:block;width:1px;height:2.7rem;flex-shrink:0"}

::: {.ChapterToc_containerOpen__XEx_6 .ChapterToc_container__mDJhZ}
::: ChapterToc_titleContainer__3Fx5b
このチャプターの目次![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgY2xhc3M9IkNoYXB0ZXJUb2NfdG9nZ2xlSWNvbl9fNERfVlQiPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTEyLjc0IDIwLjUzbC05LjI2LTkuMThhLjc1Ljc1IDAgMDEwLTEuMDdsMS4yMy0xLjIzYS43NS43NSAwIDAxMS4wNyAwbDcuNDkgNy40MSA3LjQ5LTcuNDFhLjc0Ljc0IDAgMDExLjA2IDBsMS4yNCAxLjIzYS43Ny43NyAwIDAxMCAxLjA3bC05LjI2IDkuMThhLjc0Ljc0IDAgMDEtMS4wNiAweiI+PC9wYXRoPjwvc3ZnPg==){.ChapterToc_toggleIcon__4D_VT}
:::

::: ChapterToc_toc__8_UcH
1.  [この章について](#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
2.  [context導入前 -
    doneチャネルを用いる場合のキャンセル処理](#context%E5%B0%8E%E5%85%A5%E5%89%8D---done%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E5%87%A6%E7%90%86)
3.  [contextを使った実装](#context%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%AE%9F%E8%A3%85)
    1.  [キャンセルされる側の変更点](#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%95%E3%82%8C%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9)
    2.  [キャンセルする側の変更点](#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%99%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9)
4.  [Deadlineメソッドによるタイムアウト有無・時刻の確認](#deadline%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%9C%89%E7%84%A1%E3%83%BB%E6%99%82%E5%88%BB%E3%81%AE%E7%A2%BA%E8%AA%8D)
5.  [まとめ](#%E3%81%BE%E3%81%A8%E3%82%81)
:::
:::

::: {#viewer-toc}
::: {.znc .BodyContent_anchorToHeadings__Vl0_u}
# [](#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6){.header-anchor-link} この章について {#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6}

`context.WithCancel`関数を使って作られたcontextは、`cancel()`関数を呼ぶことで手動でキャンセル処理を行いました。\
しかし、「一定時間後に自動的にタイムアウトされるようにしたい」という場合があるでしょう。

contextには、指定したDeadlineに達したら自動的にDoneメソッドチャネルをcloseする機能を組み込むことができます。\
本章ではそれについて詳しく見ていきましょう。

# [](#context%E5%B0%8E%E5%85%A5%E5%89%8D---done%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E5%87%A6%E7%90%86){.header-anchor-link} context導入前 - doneチャネルを用いる場合のキャンセル処理 {#context%E5%B0%8E%E5%85%A5%E5%89%8D---done%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E5%87%A6%E7%90%86}

contextを用いずにユーザーが定義した`done`チャネルによってキャンセル信号を伝播させる場合は、一定時間経過後のタイムアウトは`time.After`関数から得られるチャネルを明示的に使う必要があります。

::: code-block-container
``` language-go
var wg sync.WaitGroup

// キャンセルされるまでnumをひたすら送信し続けるチャネルを生成
func generator(done chan struct{}, num int) <-chan int {
    out := make(chan int)
    go func() {
        defer wg.Done()

    LOOP:
        for {
            select {
            case <-done: // doneチャネルがcloseされたらbreakが実行される
                break LOOP
            // case out <- num: これが時間がかかっているという想定
            }
        }

        close(out)
        fmt.Println("generator closed")
    }()
    return out
}

func main() {
    // doneチャネルがcloseされたらキャンセル
    done := make(chan struct{})
    gen := generator(done, 1)
    deadlineChan := time.After(time.Second)

    wg.Add(1)

LOOP:
    for i := 0; i < 5; i++ {
        select {
        case result := <-gen: // genから値を受信できた場合
            fmt.Println(result)
        case <-deadlineChan: // 1秒間受信できなかったらタイムアウト
            fmt.Println("timeout")
            break LOOP
        }
    }
    close(done)

    wg.Wait()
}
```
:::

::: msg
`time.After`を使ったタイムアウトについての詳細は、拙著[Zenn -
Goでの並行処理を徹底解剖!
第5章](https://zenn.dev/hsaki/books/golang-concurrency/viewer/appliedusage#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85)をご覧ください。
:::

# [](#context%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%AE%9F%E8%A3%85){.header-anchor-link} contextを使った実装 {#context%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%AE%9F%E8%A3%85}

上の処理は、contextを使って以下のように書き換えることができます。

::: code-block-container
``` {.diff-highlight .language-diff-go}
var wg sync.WaitGroup

-func generator(done chan struct{}, num int) <-chan int {
+func generator(ctx context.Context, num int) <-chan int {
 out := make(chan int)

    go func() {
        defer wg.Done()

    LOOP:
        for {
            select {
-            case <-done:
+          case <-ctx.Done():
             break LOOP
            // case out <- num: これが時間がかかっているという想定
            }
        }

        close(out)
        fmt.Println("generator closed")
    }()
    return out
}

func main() {
-    done := make(chan struct{})
- gen := generator(done, 1)
- deadlineChan := time.After(time.Second)
+  ctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(time.Second))
+    gen := generator(ctx, 1)

    wg.Add(1)

LOOP:
    for i := 0; i < 5; i++ {
        select {
-        case result := <-gen:
-         fmt.Println(result)
-     case <-deadlineChan: // 1秒間selectできなかったら
-         fmt.Println("timeout")
-         break LOOP

+     case result, ok := <-gen:
+            if ok {
+                fmt.Println(result)
+            } else {
+                fmt.Println("timeout")
+                break LOOP
+            }
     }
    }
-    close(done)
+  cancel()

    wg.Wait()
}
```
:::

## [](#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%95%E3%82%8C%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9){.header-anchor-link} キャンセルされる側の変更点 {#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%95%E3%82%8C%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9}

`generator`関数内での変更点は以下の通りです。

-   `generator`に渡される引数が、キャンセル処理用の`done`チャネル→contextに変更
-   キャンセル有無の判定根拠が、`<-done`→`<-ctx.Done()`に変更

この変更については、前章の「`Done`メソッドによるキャンセル有無判定」と内容は変わりありません。

明示的なキャンセル処理から一定時間経過後の自動タイムアウトへの変更によって生じる差異は、キャンセルする側で生成するcontextに現れます。

## [](#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%99%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9){.header-anchor-link} キャンセルする側の変更点 {#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%99%E3%82%8B%E5%81%B4%E3%81%AE%E5%A4%89%E6%9B%B4%E7%82%B9}

`main`関数内での変更点は以下の通りです。

-   `done`チャネルの代わりに`context.Background()`,
    `context.WithDeadline()`関数を用いてコンテキストを生成
-   `select`文中でのタイムアウト有無の判定方法
-   キャンセル処理が、`done`チャネルの明示的close→`context.WithDeadline()`関数から得られた`cancel()`関数の実行に変更

::: code-block-container
``` {.diff-highlight .language-diff-go}
// 再掲
func main() {
-    done := make(chan struct{})
- gen := generator(done, 1)
- deadlineChan := time.After(time.Second)
+  ctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(time.Second))
+    gen := generator(ctx, 1)

    wg.Add(1)

LOOP:
    for i := 0; i < 5; i++ {
        select {
-        case result := <-gen:
-         fmt.Println(result)
-     case <-deadlineChan: // 1秒間selectできなかったら
-         fmt.Println("timeout")
-         break LOOP

+     case result, ok := <-gen:
+            if ok {
+                fmt.Println(result)
+            } else {
+                fmt.Println("timeout")
+                break LOOP
+            }
     }
    }
-    close(done)
+  cancel()

    wg.Wait()
}
```
:::

### [](#%E8%87%AA%E5%8B%95%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AE%E8%BF%BD%E5%8A%A0){.header-anchor-link} 自動タイムアウト機能の追加 {#%E8%87%AA%E5%8B%95%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AE%E8%BF%BD%E5%8A%A0}

#### [](#withdeadline%E9%96%A2%E6%95%B0){.header-anchor-link} `WithDeadline`関数 {#withdeadline%E9%96%A2%E6%95%B0}

`context.WithDeadline`関数を使うことで、指定された**時刻**に自動的にDoneメソッドチャネルがcloseされるcontextを作成することができます。

::: code-block-container
``` language-go
func WithDeadline(parent Context, d time.Time) (Context, CancelFunc)
```
:::

出典:[pkg.go.dev - context
pkg](https://pkg.go.dev/context@go1.17#WithDeadline)

`WithDeadline`関数から得られるcontextは、「引数として渡された親contextの設定を引き継いだ上で、Doneメソッドチャネルが第二引数で指定した時刻に自動closeされる新たなcontext」ものになります。\
また、タイムアウト時間前にキャンセル処理を行いたいという場合は、第二返り値で得られた`cancel`関数を呼び出すことでもDoneメソッドチャネルを手動でcloseさせることができます。

::: code-block-container
``` language-go
ctx, cancel := context.WithDeadline(parentCtx, time.Now().Add(time.Second))
// このctxは、時刻time.Now().Add(time.Second)に自動キャンセルされる

cancel() 
// 明示的にcancelさせることも可能

// ctxはparentCtxとは別物なので、parentCtxはcancel()の影響を受けない
```
:::

#### [](#withtimeout%E9%96%A2%E6%95%B0){.header-anchor-link} `WithTimeout`関数 {#withtimeout%E9%96%A2%E6%95%B0}

自動タイムアウトするタイミングを、時刻ではなく**時間**で指定したい場合は、`context.WithTimeout`関数を使います。

::: code-block-container
``` language-go
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
```
:::

出典:[pkg.go.dev - context
pkg](https://pkg.go.dev/context@go1.17#WithTimeout)

そのため、`WithDeadline`関数を用いたcontext生成は`WithTimeout`関数を使って書き換えることもできます。\
例えば、以下の2つはどちらも「1秒後にタイムアウトさせるcontext」を生成します。

::: code-block-container
``` language-go
// 第二引数に時刻 = time.Timeを指定
ctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(time.Second))

// 第二引数に時間 = time.Durationを指定
ctx, cancel := context.WithTimeout(context.Background(), time.Second)
```
:::

### [](#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%9C%89%E7%84%A1%E3%81%AE%E5%88%A4%E5%AE%9A){.header-anchor-link} タイムアウト有無の判定 {#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%9C%89%E7%84%A1%E3%81%AE%E5%88%A4%E5%AE%9A}

contextによる自動タイムアウトの導入によって、`main`関数内でタイムアウトしたか否かを判定するロジックが変わっています。

::: code-block-container
``` {.diff-highlight .language-diff-go}
// 再掲
-deadlineChan := time.After(time.Second)
select {
-case result := <-gen:
- fmt.Println(result)
-case <-deadlineChan: // 1秒間selectできなかったら
- fmt.Println("timeout")
- break LOOP

+case result, ok := <-gen:
+    if ok {
+        fmt.Println(result)
+    } else {
+        fmt.Println("timeout")
+        break LOOP
+    }
}
```
:::

変更前では「一定時間経っても返答が得られないかどうか」は、呼び出し側である`main`関数中で、`case`文と`time.After`関数を組み合わせる形で判定する必要がありました。

しかし、変更後はタイムアウトした場合、`gen`チャネルを得るために呼び出された側である`generator`関数中で`gen`チャネルのclose処理まで行われるようになります。\
そのため、タイムアウトかどうかを判定するためには、「`gen`チャネルからの受信が、チャネルcloseによるものなのか否か(=`ok`のbool値に対応)」を見るだけで実現できるようになりました。

### [](#%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AA%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E5%87%A6%E7%90%86%E3%81%AE%E5%A4%89%E6%9B%B4){.header-anchor-link} 明示的なキャンセル処理の変更 {#%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AA%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E5%87%A6%E7%90%86%E3%81%AE%E5%A4%89%E6%9B%B4}

context導入によって、明示的なキャンセル指示の方法が「`done`チャネルの明示的close→`cancel`関数の実行」に変わっています。

::: code-block-container
``` {.diff-highlight .language-diff-go}
// 再掲
-close(done)
+cancel()
```
:::

`WithDeadline`関数・`WithTimeout`関数による自動タイムアウトが行われると、Doneメソッドチャネルが自動的にcloseされます。\
それでは、タイムアウトされた後に`cancel`関数を呼び出すといったいどうなるのでしょうか。\
closedなチャネルをcloseしようとするとpanicになりますが、そうなってしまうのでしょうか。

正解は「**panicにならず、正常に処理が進む**」です。\
context生成時に得られる`cancel`関数は、「すでにDoneメソッドチャネルがcloseされているときに呼ばれたら、何もしない」というような制御がきちんと行われています。そのためpanicに陥ることはありません。

そのため、ドキュメントでは「タイムアウト設定をしていた場合にも、明示的に`cancel`を呼ぶべき」という記述があります。

> **Even though ctx will be expired, it is good practice to call its
> cancellation function in any case.**\
> Failure to do so may keep the context and its parent alive longer than
> necessary.
>
> (訳)**`ctx`がタイムアウト済みであっても、明示的に`cancel`を呼び出すべきでしょう。**\
> そうでなければ、コンテキストやその親contextが不必要にメモリ上に残ったままになる可能性があります(contextリーク)。
>
> 出典:[pkg.go.dev - context pkg
> #example-WithDeadline](https://pkg.go.dev/context#example-WithDeadline)

# [](#deadline%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%9C%89%E7%84%A1%E3%83%BB%E6%99%82%E5%88%BB%E3%81%AE%E7%A2%BA%E8%AA%8D){.header-anchor-link} Deadlineメソッドによるタイムアウト有無・時刻の確認 {#deadline%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E6%9C%89%E7%84%A1%E3%83%BB%E6%99%82%E5%88%BB%E3%81%AE%E7%A2%BA%E8%AA%8D}

さて、あるcontextにタイムアウトが設定されているかどうか確認したい、ということもあるでしょう。\
そのような場合には`Deadline`メソッドを使います。

contextの`Deadline`メソッドの定義を確認してみましょう。

::: code-block-container
``` language-go
type Context interface {
    Deadline() (deadline time.Time, ok bool)
    // (以下略)
}
```
:::

出典:[pkg.go.dev - context.Context](https://pkg.go.dev/context#Context)

第二返り値のbool値を確認することで、「そのcontextにタイムアウトが設定されているか」を判定することができます。\
設定されていれば`true`、されていなければ`false`です。\
また、設定されている場合には、第一返り値にはタイムアウト時刻が格納されています。

::: code-block-container
``` language-go
ctx := context.Background()
fmt.Println(ctx.Deadline()) // 0001-01-01 00:00:00 +0000 UTC false

fmt.Println(time.Now()) // 2021-08-22 20:03:53.352015 +0900 JST m=+0.000228979
ctx, _ = context.WithTimeout(ctx, 2*time.Second)
fmt.Println(ctx.Deadline()) // 2021-08-22 20:03:55.352177 +0900 JST m=+2.000391584 true
```
:::

# [](#%E3%81%BE%E3%81%A8%E3%82%81){.header-anchor-link} まとめ {#%E3%81%BE%E3%81%A8%E3%82%81}

contextでタイムアウトを行う場合のポイントは以下4つです。

-   自動タイムアウトさせるためのcontextは、`WithDeadline`関数・`WithTimeout`関数で作れる
-   タイムアウトが設定されているcontextは、指定時刻にDoneメソッドチャネルがcloseされる
-   `WithDeadline`関数・`WithTimeout`関数それぞれから得られる`cancel`関数で、タイムアウト前後にもキャンセルを明示的に指示することができる
-   そのcontextのタイムアウト時刻・そもそもタイムアウトが設定されているかどうかは`Deadline`メソッドで確認できる

::: code-block-container
``` language-go
// 使用した関数・メソッド
type Context interface {
    Deadline() (deadline time.Time, ok bool)
    // (以下略)
}
func WithDeadline(parent Context, d time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
```
:::
:::
:::
:::

::: ViewerWrapper_container__Cg8HA
::: ViewerPager_container__TEu9T
[![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjQgMjQiIGZpbGw9ImN1cnJlbnRDb2xvciIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBjbGFzcz0iVmlld2VyUGFnZXJfaWNvbl9fM2hOVXAiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiPjwvcGF0aD48cGF0aCBkPSJNMjAgMTFINy44M2w1LjU5LTUuNTlMMTIgNGwtOCA4IDggOCAxLjQxLTEuNDFMNy44MyAxM0gyMHYtMnoiPjwvcGF0aD48L3N2Zz4=){.ViewerPager_icon__3hNUp}](/hsaki/books/golang-context/viewer/cancelchain){.ViewerPager_buttonPrev__wfMd1
.ViewerPager_button__t0gwO}

::: ViewerPager_buttonInner__4HQZU
::: ViewerPager_buttonLabel__XbHFo
PREV
:::

::: ViewerPager_buttonTitle__GBful
キャンセルの伝播
:::
:::

[](/hsaki/books/golang-context/viewer/err){.ViewerPager_buttonNext__UTTLi
.ViewerPager_button__t0gwO}

::: ViewerPager_buttonInner__4HQZU
::: ViewerPager_buttonLabel__XbHFo
NEXT
:::

::: ViewerPager_buttonTitle__GBful
Errメソッド
:::
:::

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjQgMjQiIGZpbGw9ImN1cnJlbnRDb2xvciIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBjbGFzcz0iVmlld2VyUGFnZXJfaWNvbl9fM2hOVXAiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiPjwvcGF0aD48cGF0aCBkPSJNMTIgNGwtMS40MSAxLjQxTDE2LjE3IDExSDR2MmgxMi4xN2wtNS41OCA1LjU5TDEyIDIwbDgtOHoiPjwvcGF0aD48L3N2Zz4=){.ViewerPager_icon__3hNUp}
:::
:::
:::

[← 終了する](/hsaki/books/golang-context){.View_menuButtonText__bdwP1
.View_menuButton__6pqFT}

::: View_fontToggleContainer__X2wNX
[]{.View_fontToggleContent__mTbxr}

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNOC40IDMuMkwzLjMgMTYuOGgyLjFMNyAxMi42aDUuMmwuOS0yLjQtMi42LTYuOUg4LjR6bTEgMi44bDEuNyA0LjVINy44TDkuNCA2em03LjMuM2wtNS4xIDEzLjZoMi4xbDEuNi00LjJoNWwxLjYgNC4ySDI0TDE4LjggNi4zaC0yLjF6bTEuMSAyLjhsMS43IDQuNWgtMy40bDEuNy00LjV6TTExLjUgMjJ2Mi4xSDI0VjIySDExLjV6Ij48L3BhdGg+PC9zdmc+)
:::

::: {#modal-portal}
:::
:::
