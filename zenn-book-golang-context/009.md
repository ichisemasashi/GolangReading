::: {#__next reactroot=""}
![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNMjIuOCA1LjVjLS45IDAtMS42LjctMS42IDEuNnMuNyAxLjYgMS42IDEuNiAxLjYtLjcgMS42LTEuNi0uNy0xLjYtMS42LTEuNnptLTE5LjEuNmMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMXMtLjUtMS4xLTEtMS4xSDMuN3ptMTkuMSA1LjhjLS45IDAtMS42LjctMS42IDEuNnMuNyAxLjYgMS42IDEuNiAxLjYtLjcgMS42LTEuNi0uNy0xLjYtMS42LTEuNnptLTE5LjEuNWMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMXMtLjUtMS4xLTEtMS4xSDMuN3ptMTkuMSA1LjljLS45IDAtMS42LjctMS42IDEuNiAwIC45LjcgMS42IDEuNiAxLjZzMS42LS43IDEuNi0xLjZjMC0uOS0uNy0xLjYtMS42LTEuNnptLTE5LjEuNWMtLjYgMC0xLjEuNS0xLjEgMXMuNSAxLjEgMSAxLjFoMTMuOGMuNiAwIDEuMS0uNSAxLjEtMSAwLS42LS41LTEuMS0xLTEuMUgzLjd6Ij48L3BhdGg+PC9zdmc+)

[よくわかるcontextの使い方](/hsaki/books/golang-context){.View_mobileBookTitle__NGx1l}

::: View_fontToggleContainer__X2wNX
[]{.View_fontToggleContent__mTbxr}

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNOC40IDMuMkwzLjMgMTYuOGgyLjFMNyAxMi42aDUuMmwuOS0yLjQtMi42LTYuOUg4LjR6bTEgMi44bDEuNyA0LjVINy44TDkuNCA2em03LjMuM2wtNS4xIDEzLjZoMi4xbDEuNi00LjJoNWwxLjYgNC4ySDI0TDE4LjggNi4zaC0yLjF6bTEuMSAyLjhsMS43IDQuNWgtMy40bDEuNy00LjV6TTExLjUgMjJ2Mi4xSDI0VjIySDExLjV6Ij48L3BhdGg+PC9zdmc+)
:::

::: View_sidebarWrapper__J4kZS
[![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMzc3LjQgODguMyIgaGVpZ2h0PSIyMSI+PGcgZmlsbD0iIzExMSI+PHBhdGggZD0iTTIzMyA1Ni44aC0zOWMuNSAzLjUgMi4yIDYuOCA0LjggOS4yIDIuNyAyLjMgNi4yIDMuNSA5LjggMy40IDIuOCAwIDUuNi0uNSA4LjItMS43IDIuNS0xLjEgNC44LTIuOCA2LjUtNWw4LjIgOS41Yy0yLjUgMy40LTUuNyA2LjEtOS41IDcuOS00LjYgMi4yLTkuNiAzLjMtMTQuNyAzLjItNS43LjEtMTEuNC0xLjItMTYuNS00LTQuNS0yLjUtOC4yLTYuMy0xMC43LTEwLjlzLTMuOC05LjgtMy43LTE1LjF2LTIuMmMtLjEtNS43IDEuMS0xMS4zIDMuNS0xNi41IDIuMi00LjcgNS43LTguNiAxMC4xLTExLjMgNC43LTIuOCAxMC4xLTQuMiAxNS41LTQuMSA1LjItLjEgMTAuMyAxLjEgMTQuOSAzLjcgNC4xIDIuNSA3LjQgNi4yIDkuNCAxMC41IDIuMiA1LjEgMy4zIDEwLjUgMy4yIDE2LjF2Ny4zem0tMTYuOS0xMi45Yy4xLTIuOS0uOS01LjctMi44LTcuOS0xLjgtMS45LTQuNC0yLjktNy45LTIuOS0yLjktLjEtNS44IDEuMS03LjcgMy4yLTIgMi42LTMuMyA1LjctMy42IDloMjJ2LTEuNHpNMTI4LjMgNjcuOWgzNi4xdjE0LjdoLTU2LjlWNzJsMzUuOC01NC4zaC0zNi4yVjIuOWg1Ni42djEwLjRsLTM1LjQgNTQuNnpNMjQ4LjggNTAuN2MwLTE5LjEgMTIuNy0yOS4yIDI4LjItMjkuMnMyNy45IDEwLjEgMjcuOSAyOS4yVjgyaC0xNlY1MS40YzAtMTAuNi00LjgtMTYuMS0xMi0xNi4xcy0xMi40IDUuNS0xMi40IDE2LjF2MzAuN2gtMTUuOGwuMS0zMS40ek0zMjAuMyA1MC43YzAtMTkuMSAxMi43LTI5LjIgMjguMi0yOS4yczI3LjkgMTAuMSAyNy45IDI5LjJWODJoLTE2VjUxLjRjMC0xMC42LTQuOC0xNi4xLTEyLTE2LjFTMzM2IDQwLjggMzM2IDUxLjR2MzAuN2gtMTUuOGwuMS0zMS40eiI+PC9wYXRoPjwvZz48cGF0aCBmaWxsPSIjM0VBOEZGIiBjbGFzcz0ibG9nb19zdmdfX3N0MCIgZD0iTTIuNCA4My4zaDE3Yy45IDAgMS43LS41IDIuMi0xLjJMNjguNCA1LjJjLjYtMS0uMS0yLjItMS4zLTIuMkg1MWMtLjggMC0xLjUuNC0xLjkgMS4xTDEuNiA4MS45Yy0uMy42LjEgMS40LjggMS40ek02MSA4Mi4xbDIyLjEtMzUuNWMuNy0xLjEtLjEtMi41LTEuNC0yLjVoLTE2Yy0uNiAwLTEuMi4zLTEuNS44TDQxLjUgODEuMmMtLjYuOS4xIDIuMSAxLjIgMi4xSDU5Yy44IDAgMS42LS40IDItMS4yeiI+PC9wYXRoPjwvc3ZnPg==)](/){.View_sidebarLogo__U_3VI}

::: View_sidebarScrollArea__VkX5E
::: View_sidebarBook__n15Cv
[](/hsaki/books/golang-context){.View_sidebarBookCover__tuM0r}

::: {.BookCoverImage_container__e04p5 .BookCoverImage_border__dyU2h style="width:70px"}
![よくわかるcontextの使い方](https://res.cloudinary.com/zenn/image/fetch/s--xe7dAlE9--/c_fill%2Cf_jpg%2Cfl_progressive%2Ch_350%2Cq_80%2Cw_250/https://storage.googleapis.com/zenn-user-upload/book_cover/4edbbf97c2.jpg){width="70"
height="98"}
:::

::: View_sidebarBookInfo__N_tXH
[よくわかるcontextの使い方](/hsaki/books/golang-context){.View_sidebarBookTitle__IRpEP}[]{style="display:block;width:1px;height:0.3rem;flex-shrink:0"}

::: {.LikeButton_container__lhHqp .style-large}
![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMTEwIDExMCIgY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZV9fX2Rtd00iPjxwYXRoIGNsYXNzPSJMaWtlQnV0dG9uX3N2Z0xpa2VMaW5lX19uY1lnNyIgZD0iTTczLDI0YTIzLjc4LDIzLjc4LDAsMCwwLTE1Ljg5LDYuMTksMy4xNCwzLjE0LDAsMCwxLTQuMTgsMEEyMy44MSwyMy44MSwwLDAsMCwzNywyNGEyMiwyMiwwLDAsMC0yMiwyMmMwLDE2LjY3LDE5LjY0LDMyLjgyLDI1LjExLDM3LjkzLDIuODQsMi42NSw2LjE1LDUuNjQsOC45Miw4LjEzYTguOSw4LjksMCwwLDAsMTEuOSwwYzIuNzctMi40OSw2LjA3LTUuNDgsOC45MS04LjEzQzc1LjM3LDc4LjgxLDk1LDYyLjY2LDk1LDQ2QTIyLDIyLDAsMCwwLDczLDI0WiIgZmlsbD0iY3VycmVudENvbG9yIj48L3BhdGg+PHBhdGggY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZUlubmVyX19BT0dfdCIgZmlsbD0iY3VycmVudENvbG9yIiBkPSJNNjYuMjUsNzYuNDJjLS43MS42NC0xLjMyLDEuMi0xLjgyLDEuNjctMi41MSwyLjMzLTUuMzksNS03Ljk0LDcuMjVhMi4yMSwyLjIxLDAsMCwxLTMsMEM1MSw4Myw0OC4xLDgwLjQyLDQ1LjU5LDc4LjA5Yy0uNS0uNDctMS4xMi0xLTEuODItMS42N0MzOC4wOSw3MS4yOSwyMyw1Ny42NywyMyw0NkExNCwxNCwwLDAsMSwzNywzMmExNS45MiwxNS45MiwwLDAsMSwxMS42NSw1LjIzbDQuNzMsNWEyLjIsMi4yLDAsMCwwLDMuMjMsMGw0LjcyLTVBMTYuMDYsMTYuMDYsMCwwLDEsNzMsMzIsMTQsMTQsMCwwLDEsODcsNDZDODcsNTcuNjcsNzEuOTMsNzEuMjksNjYuMjUsNzYuNDJaIj48L3BhdGg+PGcgY2xhc3M9Ikxpa2VCdXR0b25fc3ZnTGlrZURlY29yYXRpb25fX1gydjUzIj48Y2lyY2xlIGN4PSI0MS41IiBjeT0iOS41IiByPSIzLjUiIGZpbGw9IiMzZWE4ZmYiPjwvY2lyY2xlPjxjaXJjbGUgY3g9Ijk4LjUiIGN5PSIyNi41IiByPSIzLjUiIGZpbGw9IiNmZmRjNmUiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEzIiBjeT0iMTkiIHI9IjUiIGZpbGw9IiNjMDY3ZjQiPjwvY2lyY2xlPjxjaXJjbGUgY3g9Ijc3IiBjeT0iOSIgcj0iNSIgZmlsbD0iI2Y3NjY4NSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjYuNSIgY3k9IjkyLjUiIHI9IjMuNSIgZmlsbD0iI2Y3NjY4NSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTA1LjUiIGN5PSI0OC41IiByPSIzLjUiIGZpbGw9IiNjMDY3ZjQiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjQuNSIgY3k9IjYwLjUiIHI9IjMuNSIgZmlsbD0iIzNlYThmZiI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iOTQuNSIgY3k9IjczLjUiIHI9IjEuNSIgZmlsbD0iIzNlYThmZiI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTYuNSIgY3k9Ijc1LjUiIHI9IjEuNSIgZmlsbD0iI2ZmZGM2ZSI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iNzguNSIgY3k9IjkxLjUiIHI9IjEuNSIgZmlsbD0iI2ZmZGM2ZSI+PC9jaXJjbGU+PC9nPjwvc3ZnPg==){.LikeButton_svgLike___dmwM}
:::
:::
:::

::: View_sidebarChapters__oJuLT
[[01]{.View_sidebarChapterNum__oSZ_8}はじめに](/hsaki/books/golang-context/viewer/intro){#chapter-1
.View_sidebarChapterLink__hQp61}[[02]{.View_sidebarChapterNum__oSZ_8}contextの概要](/hsaki/books/golang-context/viewer/definition){#chapter-2
.View_sidebarChapterLink__hQp61}[[03]{.View_sidebarChapterNum__oSZ_8}Doneメソッド](/hsaki/books/golang-context/viewer/done){#chapter-3
.View_sidebarChapterLink__hQp61}[[04]{.View_sidebarChapterNum__oSZ_8}キャンセルの伝播](/hsaki/books/golang-context/viewer/cancelchain){#chapter-4
.View_sidebarChapterLink__hQp61}[[05]{.View_sidebarChapterNum__oSZ_8}Deadlineメソッドとタイムアウト](/hsaki/books/golang-context/viewer/deadline){#chapter-5
.View_sidebarChapterLink__hQp61}[[06]{.View_sidebarChapterNum__oSZ_8}Errメソッド](/hsaki/books/golang-context/viewer/err){#chapter-6
.View_sidebarChapterLink__hQp61}[[07]{.View_sidebarChapterNum__oSZ_8}Valueメソッド](/hsaki/books/golang-context/viewer/value){#chapter-7
.View_sidebarChapterLink__hQp61}[[08]{.View_sidebarChapterNum__oSZ_8}Valueメソッドを有効に使うtips](/hsaki/books/golang-context/viewer/appliedvalue){#chapter-8
.View_sidebarChapterLink__hQp61}[[09]{.View_sidebarChapterNum__oSZ_8}contextの具体的な使用例](/hsaki/books/golang-context/viewer/usage){#chapter-9
.View_sidebarChapterLinkActive__XxopU
.View_sidebarChapterLink__hQp61}[[10]{.View_sidebarChapterNum__oSZ_8}パッケージへのcontext導入について](/hsaki/books/golang-context/viewer/pkgdesign){#chapter-10
.View_sidebarChapterLink__hQp61}[[11]{.View_sidebarChapterNum__oSZ_8}contextの内部実体](/hsaki/books/golang-context/viewer/internal){#chapter-11
.View_sidebarChapterLink__hQp61}[[12]{.View_sidebarChapterNum__oSZ_8}おわりに](/hsaki/books/golang-context/viewer/appendix){#chapter-12
.View_sidebarChapterLink__hQp61}
:::
:::
:::

::: {.section .View_section__8hd21 style="font-size:16px"}
::: View_sectionHeader__JGnT7
::: ViewerWrapper_container__Cg8HA
::: View_chapterContent__FQOka
[Chapter 09]{.View_chapterTitleNumber__23_eN}
:::

[]{style="display:block;width:1px;height:0.7rem;flex-shrink:0"}

# contextの具体的な使用例 {#contextの具体的な使用例 .View_chapterTitle__tslMs}

[]{style="display:block;width:1px;height:0.8rem;flex-shrink:0"}[](/hsaki){.UserLinkSmall_container__PkgaY}

::: {style="width:35px;height:35px"}
![さき(H.Saki)](https://res.cloudinary.com/zenn/image/fetch/s--FESoQ9n2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_70/https://storage.googleapis.com/zenn-user-upload/avatar/51291e09a0.jpeg){.AvatarImage_border__33_UE
.AvatarImage_plain__BCJNs width="35" height="35" loading="lazy"
referrerpolicy="no-referrer"}
:::

::: {.UserLinkSmall_text__2BG_S style="width:calc(100% - 35px);font-size:0.87rem"}
::: UserLinkSmall_name__eqTEi
さき(H.Saki)
:::

::: UserLinkSmall_additionalText__2MgRM
2021.08.29に更新
:::
:::
:::
:::

::: ViewerWrapper_container__Cg8HA
[]{style="display:block;width:1px;height:2.7rem;flex-shrink:0"}

::: {.ChapterToc_containerOpen__XEx_6 .ChapterToc_container__mDJhZ}
::: ChapterToc_titleContainer__3Fx5b
このチャプターの目次![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgY2xhc3M9IkNoYXB0ZXJUb2NfdG9nZ2xlSWNvbl9fNERfVlQiPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTEyLjc0IDIwLjUzbC05LjI2LTkuMThhLjc1Ljc1IDAgMDEwLTEuMDdsMS4yMy0xLjIzYS43NS43NSAwIDAxMS4wNyAwbDcuNDkgNy40MSA3LjQ5LTcuNDFhLjc0Ljc0IDAgMDExLjA2IDBsMS4yNCAxLjIzYS43Ny43NyAwIDAxMCAxLjA3bC05LjI2IDkuMThhLjc0Ljc0IDAgMDEtMS4wNiAweiI+PC9wYXRoPjwvc3ZnPg==){.ChapterToc_toggleIcon__4D_VT}
:::

::: ChapterToc_toc__8_UcH
1.  [この章について](#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
2.  [作るもの](#%E4%BD%9C%E3%82%8B%E3%82%82%E3%81%AE)
3.  [作成](#%E4%BD%9C%E6%88%90)
    1.  [エントリポイント(main)](#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88(main))
    2.  [サーバー(server)](#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC(server))
    3.  [ハンドラ(handlers)](#%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9(handlers))
    4.  [リクエストスコープな値の共有(session,
        auth)](#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AA%E5%80%A4%E3%81%AE%E5%85%B1%E6%9C%89(session%2C-auth))
:::
:::

::: {#viewer-toc}
::: {.znc .BodyContent_anchorToHeadings__Vl0_u}
# [](#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6){.header-anchor-link} この章について {#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6}

この章では、今まで紹介したcontextの機能をフルで使ったコードを書いてみたいと思います。

# [](#%E4%BD%9C%E3%82%8B%E3%82%82%E3%81%AE){.header-anchor-link} 作るもの {#%E4%BD%9C%E3%82%8B%E3%82%82%E3%81%AE}

今回は「httpサーバーもどき」を作ろうと思います。\
要件は以下の通りです。

\<機能要件>

-   `go run main.go`で起動
-   起動後に標準入力された値「`path`,
    `token`」を基に、しかるべきハンドラにルーティング
-   ルーティング後のハンドラにて、DBからのデータ取得→レスポンス作成の処理を行い、そのレスポンスの内容を標準出力に書き込む

\<非機能要件>

-   DBからのデータ取得が、2秒以内に終了しなければタイムアウトさせる

# [](#%E4%BD%9C%E6%88%90){.header-anchor-link} 作成 {#%E4%BD%9C%E6%88%90}

## [](#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88(main)){.header-anchor-link} エントリポイント(main) {#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88(main)}

まずは`go run main.go`でサーバーを起動させるエンドポイントである`main.go`を作っていきます。

::: code-block-container
``` language-go
package main

func main() {
    srv := server.DefaultServer
    srv.ListenAndServe()
}
```
:::

やっていることは、

1.  自分で定義・設計した`server.DefaultServer`を取得
2.  サーバーを起動

です。ここではまだcontextが絡む様子は見当たりません。

## [](#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC(server)){.header-anchor-link} サーバー(server) {#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC(server)}

それでは、エントリポイント中で起動しているサーバーの中身を見てみましょう。

### [](#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8A){.header-anchor-link} リクエストの読み取り {#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8A}

::: code-block-container
``` language-go
package server

type MyServer struct {
    router map[string]handlers.MyHandleFunc
}

func (srv *MyServer) ListenAndServe() {
    for {
        var path, token string
        fmt.Scan(&path)
        fmt.Scan(&token)

        ctx := session.SetSessionID(context.Background())
        go srv.Request(ctx, path, token)
    }
}
```
:::

`ListenAndServe`メソッドでは、`for`無限ループを回すことによって起動中にリクエストを受け取り続けます。\
リクエストを受け取る処理は、以下のように実装されています。

1.  標準入力からリクエスト内容(パス、トークン)を読み込む
2.  contextを作成し、それにトレースのための内部IDをつける
3.  別ゴールーチンを起動し、リクエストを処理させる

リクエストを処理させているのは、`Request`メソッドです。次にこれの中身を見ていきましょう。

### [](#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0){.header-anchor-link} ルーティング {#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0}

`Request`メソッドの中身は、

1.  ハンドラに渡すリクエスト構造体を作り、
2.  リクエストスコープな値をcontextに詰めて
3.  ルーティングする

というものです。

::: code-block-container
``` language-go
package server

func (srv *MyServer) Request(ctx context.Context, path string, token string) {
    // リクエストオブジェクト作成
    var req handlers.MyRequest
    req.SetPath(path)

    // (key:authToken <=> value:token)をcontextに入れる
    ctx = auth.SetAuthToken(ctx, token)

    // ルーティング操作
    if handler, ok := srv.router[req.GetPath()]; ok {
        handler(ctx, req)
    } else {
        handlers.NotFoundHandler(ctx, req)
    }
}
```
:::

最終的に、「ルーティング先が見つかったら`handler`を、見つからなければ`NotFoundHandler`を呼び出す」という操作に行きついています。\
次に、呼び出されるハンドラの中の一つを見てみましょう。

## [](#%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9(handlers)){.header-anchor-link} ハンドラ(handlers) {#%E3%83%8F%E3%83%B3%E3%83%89%E3%83%A9(handlers)}

`handlers`パッケージ内では、ハンドラを表す独自型として`MyHandleFunc`というものを定義しました。\
この型を満たす変数の一つとして、ハンドラ`GetGreeting`を定義しました。

そしてその中で、

-   トークン検証
-   DBリクエスト(タイムアウトあり)
-   レスポンス返却

までの処理を行わせています。

::: code-block-container
``` language-go
package handlers

type MyHandleFunc func(context.Context, MyRequest)

var GetGreeting MyHandleFunc = func(ctx context.Context, req MyRequest) {
    var res MyResponse

    // トークンからユーザー検証→ダメなら即return
    userID, err := auth.VerifyAuthToken(ctx)
    if err != nil {
        res = MyResponse{Code: 403, Err: err}
        fmt.Println(res)
        return
    }

    // DBリクエストをいつタイムアウトさせるかcontext経由で設定
    dbReqCtx, cancel := context.WithTimeout(ctx, 2*time.Second)

    //DBからデータ取得
    rcvChan := db.DefaultDB.Search(dbReqCtx, userID)
    data, ok := <-rcvChan
    cancel()

    // DBリクエストがタイムアウトしていたら408で返す
    if !ok {
        res = MyResponse{Code: 408, Err: errors.New("DB request timeout")}
        fmt.Println(res)
        return
    }

    // レスポンスの作成
    res = MyResponse{
        Code: 200,
        Body: fmt.Sprintf("From path %s, Hello! your ID is %d\ndata → %s", req.path, userID, data),
    }

    // レスポンス内容を標準出力(=本物ならnet.Conn)に書き込み
    fmt.Println(res)
}
```
:::

## [](#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AA%E5%80%A4%E3%81%AE%E5%85%B1%E6%9C%89(session%2C-auth)){.header-anchor-link} リクエストスコープな値の共有(session, auth) {#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AA%E5%80%A4%E3%81%AE%E5%85%B1%E6%9C%89(session%2C-auth)}

この「httpサーバーもどき」で登場したリクエストスコープ値は2つありました。

-   トレースのための内部ID(sesssion)
-   認証トークン(auth)

これらをcontext中に格納したり、逆にcontext中から読み出したりする関数を、別パッケージの形で提供しました。

::: code-block-container
``` language-go
package session

type ctxKey int

const (
    sessionID ctxKey = iota
)

var sequence int = 1

func SetSessionID(ctx context.Context) context.Context {
    idCtx := context.WithValue(ctx, sessionID, sequence)
    sequence += 1
    return idCtx
}

func GetSessionID(ctx context.Context) int {
    id := ctx.Value(sessionID).(int)
    return id
}
```
:::

::: code-block-container
``` language-go
package auth

type ctxKey int

const (
    authToken ctxKey = iota
)

func SetAuthToken(ctx context.Context, token string) context.Context {
    return context.WithValue(ctx, authToken, token)
}

func getAuthToken(ctx context.Context) (string, error) {
    if token, ok := ctx.Value(authToken).(string); ok {
        return token, nil
    }
    return "", errors.New("cannot find auth token")
}

func VerifyAuthToken(ctx context.Context) (int, error) {
    // token取得
    token, err := getAuthToken(ctx)
    if err != nil {
        return 0, err
    }

    // token検証作業→userID取得
    userID := len(token)
    if userID < 3 {
        return 0, errors.New("forbidden")
    }

    return userID, nil
}
```
:::

これらをわざわざ別パッケージに切り出したのは、利便性向上のためです。

例えば、今回は`auth`パッケージの中に入れた認証トークン周りの機能(=`SetAuthToken`,`VerifyAuthToken`関数)を`handlers`パッケージの中に入れてしまったとしましょう。\
そして、そのトークン認証機能を、`handlers`とは別の`db`パッケージでも使いたい、という風になったとしましょう。

すると、

-   `handlers` ←
    この中の認証トークン周りの機能を`db`パッケージで使いたい
-   `db` ← この中のDBデータ取得機能を`handlers`パッケージで使いたい

という循環参照を引き起こしてしまう可能性があるのです。\
そのため、「パッケージを超えてたくさんの場所で使いたい！」というcontext
Valueは別パッケージに切り出すのが便利でしょう。
:::
:::
:::

::: ViewerWrapper_container__Cg8HA
::: ViewerPager_container__TEu9T
[![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjQgMjQiIGZpbGw9ImN1cnJlbnRDb2xvciIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBjbGFzcz0iVmlld2VyUGFnZXJfaWNvbl9fM2hOVXAiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiPjwvcGF0aD48cGF0aCBkPSJNMjAgMTFINy44M2w1LjU5LTUuNTlMMTIgNGwtOCA4IDggOCAxLjQxLTEuNDFMNy44MyAxM0gyMHYtMnoiPjwvcGF0aD48L3N2Zz4=){.ViewerPager_icon__3hNUp}](/hsaki/books/golang-context/viewer/appliedvalue){.ViewerPager_buttonPrev__wfMd1
.ViewerPager_button__t0gwO}

::: ViewerPager_buttonInner__4HQZU
::: ViewerPager_buttonLabel__XbHFo
PREV
:::

::: ViewerPager_buttonTitle__GBful
Valueメソッドを有効に使うtips
:::
:::

[](/hsaki/books/golang-context/viewer/pkgdesign){.ViewerPager_buttonNext__UTTLi
.ViewerPager_button__t0gwO}

::: ViewerPager_buttonInner__4HQZU
::: ViewerPager_buttonLabel__XbHFo
NEXT
:::

::: ViewerPager_buttonTitle__GBful
パッケージへのcontext導入について
:::
:::

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjQgMjQiIGZpbGw9ImN1cnJlbnRDb2xvciIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBjbGFzcz0iVmlld2VyUGFnZXJfaWNvbl9fM2hOVXAiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiPjwvcGF0aD48cGF0aCBkPSJNMTIgNGwtMS40MSAxLjQxTDE2LjE3IDExSDR2MmgxMi4xN2wtNS41OCA1LjU5TDEyIDIwbDgtOHoiPjwvcGF0aD48L3N2Zz4=){.ViewerPager_icon__3hNUp}
:::
:::
:::

[← 終了する](/hsaki/books/golang-context){.View_menuButtonText__bdwP1
.View_menuButton__6pqFT}

::: View_fontToggleContainer__X2wNX
[]{.View_fontToggleContent__mTbxr}

![](data:image/svg+xml;base64,PHN2ZyB2aWV3Ym94PSIwIDAgMjcgMjciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCI+PHBhdGggZmlsbD0iY3VycmVudENvbG9yIiBkPSJNOC40IDMuMkwzLjMgMTYuOGgyLjFMNyAxMi42aDUuMmwuOS0yLjQtMi42LTYuOUg4LjR6bTEgMi44bDEuNyA0LjVINy44TDkuNCA2em03LjMuM2wtNS4xIDEzLjZoMi4xbDEuNi00LjJoNWwxLjYgNC4ySDI0TDE4LjggNi4zaC0yLjF6bTEuMSAyLjhsMS43IDQuNWgtMy40bDEuNy00LjV6TTExLjUgMjJ2Mi4xSDI0VjIySDExLjV6Ij48L3BhdGg+PC9zdmc+)
:::

::: {#modal-portal}
:::
:::
